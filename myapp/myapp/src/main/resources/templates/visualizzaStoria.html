<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storie Disponibili</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <h1>Storie Disponibili</h1>
        <div>
            <input type="text" id="searchInput" placeholder="Cerca per titolo..." oninput="filterStorie()">
            <select id="filterUsername" onchange="filterStorie()">
                <option value="">Filtra per username</option>
                <!-- TODO: Popola con gli username disponibili -->
            </select>
            <select id="filterLunghezza" onchange="filterStorie()">
                <option value="">Filtra per lunghezza</option>
                <option value="0-5">0-5 scenari</option>
                <option value="5-10">5-10 scenari</option>
                <option value="10+">10+ scenari</option>
            </select>
            <select id="filterStato" onchange="filterStorie()">
                <option value="">Filtra per stato</option>
                <option value="non_iniziato">Non iniziato</option>
                <option value="in_corso">In corso</option>
                <option value="concluso">Concluso</option>
            </select>
        </div>
    </header>

    <div id="storieContainer"></div>

    <footer>
        <p>&copy; 2024 MyApp</p>
    </footer>

    <script>
        let storie = [];

        // Fetch delle storie
        fetch('/api/storie')
            .then(response => response.json())
            .then(data => {
                storie = data;
                displayStorie(storie);
            });

        // Funzione per visualizzare le storie
        function displayStorie(storieDaVisualizzare) {
            const container = document.getElementById('storieContainer');
            container.innerHTML = ''; // Svuota il container

            storieDaVisualizzare.forEach(storia => {
                const storiaDiv = document.createElement('div');
                storiaDiv.className = 'storia-box';

                storiaDiv.innerHTML = `
                    <h2>${storia.titolo}</h2>
                    <p>${storia.descrizione}</p>
                    <p><strong>Primo Scenario:</strong> ${storia.scenarioIniziale.descrizione}</p>
                    <button onclick="giocaStoria('${storia.id}')">Gioca Storia</button>
                    ${storia.giocata ? `<button onclick="riprendiStoria('${storia.id}')">Riprendi Storia</button>
                                       <button onclick="eliminaPartita('${storia.id}')">Elimina Partita</button>` : ''}
                `;
                container.appendChild(storiaDiv);
            });
        }

        // Funzione per filtrare le storie in base ai filtri applicati
        function filterStorie() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const username = document.getElementById('filterUsername').value;
            const lunghezza = document.getElementById('filterLunghezza').value;
            const stato = document.getElementById('filterStato').value;

            const storieFiltrate = storie.filter(storia => {
                return (storia.titolo.toLowerCase().includes(searchTerm) || !searchTerm) &&
                       (storia.username === username || !username) &&
                       (storia.lunghezza === lunghezza || !lunghezza) &&
                       (storia.stato === stato || !stato);
            });

            displayStorie(storieFiltrate);
        }

        function giocaStoria(storiaId) {
            window.location.href = `/gioca.html?storiaId=${storiaId}`;
        }

        function riprendiStoria(storiaId) {
            window.location.href = `/riprendi.html?storiaId=${storiaId}`;
        }

        function eliminaPartita(storiaId) {
            if (confirm("Sei sicuro di voler eliminare la partita?")) {
                fetch(`/api/eliminaPartita/${storiaId}`, {
                    method: 'DELETE'
                }).then(() => {
                    alert('Partita eliminata con successo');
                    // Ricarica le storie dopo l'eliminazione
                    fetch('/api/storie')
                        .then(response => response.json())
                        .then(data => {
                            storie = data;
                            filterStorie();
                        });
                });
            }
        }
    </script>
</body>
</html>
