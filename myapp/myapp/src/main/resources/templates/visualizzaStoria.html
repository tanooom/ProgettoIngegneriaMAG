<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storie Disponibili</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="visualizzaStoria">
    <header>
        <div class="header-content">
            <button class="back-button" onclick="window.location.href='home'">
                <img src="/css/images/arrow.png" alt="Indietro">
                <span class="back-text">Torna Indietro</span>
            </button>
            <h1>Storie Disponibili</h1>
        </div>
    </header>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Cerca per titolo..." oninput="filterStorie()">
        <select id="filterUsername" onchange="filterStorie()">
            <option value="">Filtra per username</option>
            <!-- TODO: Popola con gli username disponibili -->
        </select>
        <select id="filterLunghezza" onchange="filterStorie()">
            <option value="">Filtra per lunghezza</option>
            <option value="0-5">0-5 scenari</option>
            <option value="5-10">5-10 scenari</option>
            <option value="10+">10+ scenari</option>
        </select>
        <select id="filterStato" onchange="filterStorie()">
            <option value="">Filtra per stato</option>
            <option value="non_iniziato">Non iniziato</option>
            <option value="in_corso">In corso</option>
            <option value="concluso">Concluso</option>
        </select>
        <button class="search-button" onclick="filterStorie()">
            <img src="/css/images/search-icon.png" alt="Cerca">
        </button>
    </div>

    <div id="storieContainer"></div>

    <script>
        let storie = [];
        let usernames = []; // Array per memorizzare gli username

        // Fetch delle storie
        fetch('/api/storie')
            .then(response => response.json())
            .then(data => {
                storie = data;
                displayStorie(storie);
            });
        
        // Fetch degli username
        fetch('/api/usernames')
            .then(response => response.json())
            .then(data => {
                usernames = data;
                populateUsernameFilter(usernames);
            });

        // Funzione per popolare il filtro degli username
        function populateUsernameFilter(usernames) {
            const filterUsername = document.getElementById('filterUsername');
            usernames.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                filterUsername.appendChild(option);
            });
        }

        // Funzione per visualizzare le storie
        function displayStorie(storieDaVisualizzare) {
            const container = document.getElementById('storieContainer');
            container.innerHTML = ''; // Svuota il container

            storieDaVisualizzare.forEach(storia => {
                const storiaDiv = document.createElement('div');
                storiaDiv.className = 'storia-box';

                storiaDiv.innerHTML = `
                    <h2>${storia.titolo}</h2>
                    <p>${storia.descrizione}</p>
                    <p><strong>Primo Scenario:</strong> ${storia.scenarioIniziale.descrizione}</p>
                    <button onclick="giocaStoria('${storia.id}')">Gioca Storia</button>
                    ${storia.giocata ? `<button onclick="riprendiStoria('${storia.id}')">Riprendi Storia</button>
                                       <button onclick="eliminaPartita('${storia.id}')">Elimina Partita</button>` : ''}
                `;
                container.appendChild(storiaDiv);
            });
        }

        // Funzione per filtrare le storie in base ai filtri applicati
        function filterStorie() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const username = document.getElementById('filterUsername').value;
            const lunghezza = document.getElementById('filterLunghezza').value;
            const stato = document.getElementById('filterStato').value;

            const storieFiltrate = storie.filter(storia => {
                return (storia.titolo.toLowerCase().includes(searchTerm) || !searchTerm) &&
                       (storia.username === username || !username) &&
                       (storia.lunghezza === lunghezza || !lunghezza) &&
                       (storia.stato === stato || !stato);
            });

            displayStorie(storieFiltrate);
        }

        function giocaStoria(storiaId) {
            window.location.href = '/gioca.html?storiaId=${storiaId}';
        }

        function riprendiStoria(storiaId) {
            window.location.href = '/riprendi.html?storiaId=${storiaId}';
        }

        function eliminaPartita(storiaId) {
            if (confirm("Sei sicuro di voler eliminare la partita?")) {
                fetch('/api/eliminaPartita/${storiaId}', {
                    method: 'DELETE'
                }).then(() => {
                    alert('Partita eliminata con successo');
                    // Ricarica le storie dopo l'eliminazione
                    fetch('/api/storie')
                        .then(response => response.json())
                        .then(data => {
                            storie = data;
                            filterStorie();
                        });
                });
            }
        }
    </script>

    <footer>
        <p>&copy; 2024 MyApp</p>
    </footer>

</body>
</html>